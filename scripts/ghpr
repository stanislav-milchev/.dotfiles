#!/bin/bash

# Check if the current branch is not "main"
CURRENT_BRANCH=$(git branch --show-current)

if [ "$CURRENT_BRANCH" == "main" ]; then
    echo "Error: You must be on a branch named differently than 'main'."
    exit 1
fi

# Check for uncommitted changes
if ! git diff --quiet || ! git diff --cached --quiet; then
    echo "Error: You have uncommitted changes. Please commit or stash them before creating a PR."
    exit 1
fi

# Check if the branch is up-to-date with its remote
if ! git fetch; then
    echo "Error: Unable to fetch from remote."
    exit 1
fi

UPSTREAM=$(git rev-parse @{u} 2>/dev/null)
if [ -z "$UPSTREAM" ]; then
    echo "Error: No upstream branch configured. Please set the upstream branch."
    exit 1
fi

LOCAL=$(git rev-parse @)
REMOTE=$(git rev-parse @{u})

if [ "$LOCAL" != "$REMOTE" ]; then
    echo "Error: Your branch is not up-to-date with the remote. Please pull or push changes."
    exit 1
fi

# If all checks pass, open vim for title and body
TEMP_FILE=$(mktemp)

vim "$TEMP_FILE"

# Read the first line as title
TITLE=$(head -n 1 "$TEMP_FILE")

# Read the rest as the body
BODY=$(tail -n +2 "$TEMP_FILE")

# Ensure title and body are not empty
if [ -z "$TITLE" ]; then
    echo "Error: PR title cannot be empty."
    rm "$TEMP_FILE"
    exit 1
fi

if [ -z "$BODY" ]; then
    echo "Error: PR body cannot be empty."
    rm "$TEMP_FILE"
    exit 1
fi

# Run the gh pr create command
gh pr create --title "$TITLE" --body "$BODY"

# Clean up
rm "$TEMP_FILE"
